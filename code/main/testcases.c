/*
 *  Some testcases for SHA-256 and RSA signatures
 */

#include <stdio.h>
#include <string.h>

#include <freertos/FreeRTOS.h>
#include <freertos/task.h>

// LowNet includes.
#include "lownet.h"
#include "serial_io.h"
#include "testcases.h"
#include "util_signing.h"

#define HASH_SIZE  32
#define RSA_SIZE  256

// 4cde66b752eaa1999c7f6c84ba90f4292dffcfbba8dae64da8651b6765bc4105
static lownet_frame_t testframe_1 = { 1, 1, 1, 7, { 1, 2, 3 }, 0};


// > echo -n "a" | sha256sum 
// ca978112ca1bbdcafac231b39a23dc4da786eff8147c4e72b9807785afee48bb  -
static char letter_a = 'a';

/*
 *  RSA signature of the above testframe
 */
static uint8_t test_signature[RSA_SIZE] = {
    0x8e,0x54,0xb8,0x63,0xcc,0x1a,0xbb,0xfd,0x31,0xfd,0x23,0x9f,0x80,0x28,0x01,0x0e,
    0xde,0xfd,0x3b,0xd0,0xb3,0x37,0x83,0x04,0xd8,0x0a,0xe6,0x2b,0x10,0x25,0x1c,0x87,
    0x45,0x3b,0x4e,0x5c,0x98,0x4b,0x92,0x6f,0xfe,0x0d,0x35,0xf7,0x42,0x46,0xed,0xbf,
    0x20,0x7c,0x5c,0x0b,0x03,0x75,0xd9,0x74,0x95,0xa0,0x92,0xf6,0xd6,0x37,0xde,0x02,
    0x12,0xee,0x40,0xb8,0xf7,0x62,0x8d,0xa5,0x14,0xc5,0x03,0x3b,0x1d,0xf9,0xd1,0x67,
    0xc2,0x6a,0x79,0x13,0xe6,0xa7,0x3b,0x86,0x4d,0xa7,0x7b,0xb5,0xa1,0x70,0xc4,0xf2,
    0xa1,0x39,0x24,0xcf,0x83,0xf4,0xd9,0xa1,0x5e,0x15,0x33,0x7d,0xc9,0x13,0xfb,0x72,
    0xb6,0xec,0xeb,0x7a,0x25,0xf7,0x74,0x76,0x41,0x68,0x34,0xa7,0xe4,0x35,0x0b,0x60,
    0xc7,0xc8,0xfd,0xd9,0x58,0xbf,0xe0,0x33,0xe5,0x7c,0x29,0xf9,0xd4,0x25,0xb6,0x62,
    0x8e,0x48,0x41,0xae,0x40,0x16,0xe4,0x69,0x44,0x89,0x37,0xa3,0x57,0x4a,0x55,0xd9,
    0xb9,0x4b,0x69,0xe5,0xf1,0x8e,0xcb,0x8f,0xc7,0x3e,0x50,0xd5,0xef,0x13,0xb5,0x91,
    0x15,0xe2,0xed,0xbc,0xd9,0x3c,0x7f,0xe6,0xf1,0x0c,0x6e,0x9e,0x58,0x5c,0x16,0xd3,
    0xc3,0x4d,0x6c,0x2a,0x12,0x7d,0x17,0xa3,0x21,0x19,0x74,0x60,0xde,0xdf,0xd7,0xe3,
    0x1e,0x13,0xb5,0x04,0xef,0x59,0x0c,0xc0,0x97,0x22,0xd0,0x53,0x28,0xc0,0x33,0x14,
    0xe1,0xa0,0x89,0x06,0xcf,0xea,0x27,0xe6,0x0a,0xcc,0x30,0x46,0x68,0xd4,0x47,0x15,
    0x59,0x7e,0x72,0xe2,0xe9,0x06,0x0d,0xcd,0x72,0xd2,0x3c,0x13,0x46,0x04,0x71,0xfe
};

void print_hash( const uint8_t *hash )
{
    char buf[80];
    for( int i=0; i<HASH_SIZE; i++)
        sprintf( buf+2*i, "%02x", hash[i] );
    serial_write_line( buf );
}

void print_rsa( const uint8_t *rsa )
{
    char buf[80];

    buf[0] = '\0';
    
    for( int i=0; i<RSA_SIZE; i++)
    {
        sprintf( buf + strlen(buf), "%c%02x", (i%16)==0 ? ' ' : ',', rsa[i] );
        if ( (i % 16) == 15 )
        {
            serial_write_line( buf );
            buf[0] = '\0';
            vTaskDelay( 100 / portTICK_PERIOD_MS);
        }
    }
    serial_write_line( buf );        
}


void test_signatures( hash_f *hf, rsa_f *rf ) 
{
    uint8_t hash[ HASH_SIZE ];

    serial_write_line( "SHA-256 on letter a  (=> ca978112ca1bbdcafa...)" );
    
    (*hf)( (const uint8_t*)&letter_a, 1, hash );
    print_hash( (uint8_t *)hash );

    serial_write_line( "SHA-256 on test frame (=> 4cde66b752eaa1999c7...)" );
    (*hf)( (const uint8_t*)&testframe_1, sizeof( lownet_frame_t ), hash );
    print_hash( (uint8_t *)hash );

    uint8_t rsa2[ RSA_SIZE ];

    vTaskDelay( 500 / portTICK_PERIOD_MS);

    serial_write_line( "Decoding Signature ... (220 zeroes, 4 ones, and the hash!)" );
    (*rf)( test_signature, rsa2 );
    print_rsa( rsa2 );        
    
}

